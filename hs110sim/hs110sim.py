#!/usr/bin/env python3
from os import environ
import socket


# current=0.342122, voltage=239.527888, power=66.941523, total=10.155, err_code=0
sample_data_h1 = (
    b'\x00\x00\x00v\xd0\xf2\x97\xfa\x9f\xeb\x8e\xfc\xde\xe4'
    b'\x9f\xbd\xda\xbf\xcb\x94\xe6\x83\xe2\x8e\xfa\x93'
    b'\xfe\x9b\xb9\x83\xf8\xda\xb9\xcc\xbe\xcc\xa9\xc7'
    b'\xb3\x91\xab\x9b\xb5\x86\xb2\x80\xb1\x83\xb1\x9d'
    b'\xbf\xc9\xa6\xca\xbe\xdf\xb8\xdd\xff\xc5\xf7\xc4'
    b'\xfd\xd3\xe6\xd4\xe3\xdb\xe3\xdb\xf7\xd5\xa5\xca'
    b'\xbd\xd8\xaa\x88\xb2\x84\xb2\x9c\xa5\x91\xa0\x95'
    b'\xa7\x94\xb8\x9a\xee\x81\xf5\x94\xf8\xda\xe0\xd1'
    b'\xe1\xcf\xfe\xcb\xfe\xce\xfe\xce\xe2\xc0\xa5\xd7'
    b'\xa5\xfa\x99\xf6\x92\xf7\xd5\xef\xdf\xa2\xdf\xa2'
)
sample_data_fail = b'\x00\x00\x00v\xd0\xf2\x97\xfa'
# '{"emeter":{"get_realtime":{"current_ma":0.342122,"voltage_mv":239.527888,
# "power_mw":66.941523,"total_wh":10.155000,"err_code":0}}}'
sample_data_h2 = (
    b'\x00\x00\x00\x82\xd0\xf2\x97\xfa\x9f\xeb\x8e\xfc\xde'
    b'\xe4\x9f\xbd\xda\xbf\xcb\x94\xe6\x83\xe2\x8e\xfa\x93'
    b'\xfe\x9b\xb9\x83\xf8\xda\xb9\xcc\xbe\xcc\xa9\xc7\xb3'
    b'\xec\x81\xe0\xc2\xf8\xc8\xe6\xd5\xe1\xd3\xe2\xd0\xe2'
    b'\xce\xec\x9a\xf5\x99\xed\x8c\xeb\x8e\xd1\xbc\xca\xe8'
    b'\xd2\xe0\xd3\xea\xc4\xf1\xc3\xf4\xcc\xf4\xcc\xe0\xc2'
    b'\xb2\xdd\xaa\xcf\xbd\xe2\x8f\xf8\xda\xe0\xd6\xe0\xce'
    b'\xf7\xc3\xf2\xc7\xf5\xc6\xea\xc8\xbc\xd3\xa7\xc6\xaa'
    b'\xf5\x82\xea\xc8\xf2\xc3\xf3\xdd\xec\xd9\xec\xdc\xec'
    b'\xdc\xf0\xd2\xb7\xc5\xb7\xe8\x8b\xe4\x80\xe5\xc7\xfd'
    b'\xcd\xb0\xcd\xb0'
)

bind_IP = '0.0.0.0'
bind_PORT = 9999

my_socket = socket.socket()
my_socket.bind((bind_IP, bind_PORT))
my_socket.listen(5)

if (environ.get('HW_VERSION') == '2'):
    hw_version = 2
    return_msg = sample_data_h2
else:
    hw_version = 1
    return_msg = sample_data_h1

print("HS110sim started...")
print("HW version: %s" % hw_version)
print("watching on %s:%s" % (bind_IP, bind_PORT))

while True:
    conexion, addr = my_socket.accept()
    print(addr)

    peticion = conexion.recv(1024)
    print(peticion)

    conexion.send(return_msg)
    conexion.close()
